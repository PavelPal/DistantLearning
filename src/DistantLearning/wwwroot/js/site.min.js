"use strict";

var app = angular.module("distantLearning",
[
    "ngRoute",
    "LocalStorageModule",
    "ngResource",
    "ngMaterial",
    "ui.router",
    "ngCookies"
]);
app.config(routes);

function routes($stateProvider, $routeProvider, $httpProvider, $urlRouterProvider, $locationProvider) {

    $urlRouterProvider.otherwise("main");

    $stateProvider
        .state("main",
        {
            url: "/",
            templateUrl: "/home/index",
            controller: "mainController"
        })
        .state("login",
        {
            url: "/login",
            templateUrl: "../app/account/login.html",
            controller: "loginController"
        })
        .state("signup",
        {
            url: "/signup",
            templateUrl: "../app/account/signup.html",
            controller: "signupController"
        })
        .state("profile",
        {
            url: "/profile",
            templateUrl: "../app/profile.html"
        })
        .state("users",
        {
            url: "/users",
            templateUrl: "../app/users.html"
        })
        .state("tests",
        {
            url: "/tests",
            templateUrl: "../app/tests.html"
        })
        .state("journal",
        {
            url: "/journal",
            templateUrl: "../app/journal.html"
        })
        .state("results",
        {
            url: "/results",
            templateUrl: "../app/results.html"
        })
        .state("documents",
        {
            url: "/documents",
            templateUrl: "../app/documents.html"
        })
        .state("settings",
        {
            url: "/settings",
            templateUrl: "../app/settings.html"
        })
        .state("help",
        {
            url: "/help",
            templateUrl: "../app/help.html"
        });

    $httpProvider.interceptors.push("authInterceptorService");
}
app.run(run).config(config);

function run($rootScope, $cookies, $window, authService) {

    $rootScope.$on("$stateChangeStart",
        function(event, toState, toParams, fromState, fromParams) {
            if (toState.external) {
                event.preventDefault();
                $window.open(toState.url, "_self");
            }
        });

    $rootScope.$on("$stateChangeSuccess",
        function(event, toState, toParams, fromState, fromParams) {
            if (toState.external) {
                event.preventDefault();
                $window.open(toState.url, "_self");
            }
        });

    authService.fillAuthData();
}

function config($provide, $mdThemingProvider) {
    $provide.decorator("$locale",
        function($delegate) {
            return $delegate;
        });

    $mdThemingProvider.theme("default")
        .primaryPalette("light-blue",
        {
            'default': "800",
            'hue-1': "100",
            'hue-2': "600",
            'hue-3': "A100"
        })
        .accentPalette("pink",
        {
            'default': "400"
        })
        .warnPalette("red");
}
app.controller("loginController", loginController);

function loginController($scope, $location, authService) {

    $scope.title = "Войти";

    $scope.loginData = {
        email: "",
        password: ""
    };

    $scope.message = "";

    $scope.login = function() {
        authService.login($scope.loginData)
            .then(function(response) {
                    $location.path("/home");
                },
                function(err) {
                    $scope.message = err.error_description;
                });
    };
};
app.controller("mainController", mainController);

function mainController($scope, $timeout, $mdSidenav, $location, authService) {
    $scope.title = "Дистанционное обучение";

    $scope.toggleSideNav = toggleSideNav("sideNav");

    function toggleSideNav(componentId) {
        return function() {
            $mdSidenav(componentId)
                .toggle();
        };
    }

    $scope.logOut = function() {
        authService.logOut();
        $location.path("/home");
    };
    $scope.authentication = authService.authentication;
};
app.controller("searchController", searchController);

function searchController() {
}
app.controller("signupController", signupController);

function signupController($scope, $location, $timeout, authService) {

    $scope.title = "Зарегистрироваться";
    $scope.savedSuccessfully = false;
    $scope.message = "";

    $scope.registration = {
        firstName: "",
        lastName: "",
        email: "",
        password: "",
        confirmPassword: "",
        type: 0,
        disciplines: [],
        children: [],
        group: 0
    };

    $scope.validation = {
        email: /^[a-z]+[a-z0-9._]+@[a-z]+\.[a-z.]{2,5}$/
    };

    var startTimer = function() {
        var timer = $timeout(function() {
                $timeout.cancel(timer);
                $location.path("/login");
            },
            2000);
    };

    $scope.signUp = function() {
        if ($scope.signUpForm.$valid) {
            authService.saveRegistration($scope.registration,
                function(result) {
                    $scope.savedSuccessfully = true;
                    $scope.message =
                        "User has been registered successfully, you will be redicted to login page in 2 seconds.";
                    startTimer();
                });
        }
    };
}
app.factory("authInterceptorService", authInterceptorService);

function authInterceptorService($q, $location, localStorageService) {

    var authInterceptorServiceFactory = {};

    var request = function(config) {

        config.headers = config.headers || {};

        var authData = localStorageService.get("authorizationData");
        if (authData) {
            config.headers.Authorization = "Bearer " + authData.token;
        }

        return config;
    };
    var responseError = function(rejection) {
        if (rejection.status === 401) {
            $location.path("/login");
        }
        return $q.reject(rejection);
    };
    authInterceptorServiceFactory.request = request;
    authInterceptorServiceFactory.responseError = responseError;

    return authInterceptorServiceFactory;
}
app.factory("authService", authService);

function authService($http, $q, localStorageService) {
    var authServiceFactory = {};

    var authentication = {
        isAuth: false,
        email: "",
        emailConfirmed: false,
        userName: "",
        phoneNumber: "",
        firstName: "",
        lastName: "",
        type: ""
    };

    var logOut = function() {
        localStorageService.remove("authorizationData");
        clearData();
    };

    var saveRegistration = function(model) {
        logOut();

        return $http({
                url: "/api/account/register",
                dataType: "json",
                method: "POST",
                data: JSON.stringify(model),
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .success(function(response) {
                fromModel(response);
            })
            .error(function(error) {
                throw new Error("Error in authService. " + error);
            });
    };

    var login = function(loginData) {

        var deferred = $q.defer();

        $http({
                url: "/api/account/login",
                dataType: "json",
                method: "POST",
                data: JSON.stringify(loginData),
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .success(function(response) {
                localStorageService.set("authorizationData",
                {
                    token: response.access_token,
                    email: loginData.email,
                    emailConfirmed: loginData.emailConfirmed,
                    userName: loginData.userName,
                    phoneNumber: loginData.phoneNumber,
                    firstName: loginData.firstName,
                    lastName: loginData.lastName,
                    type: loginData.type
                });

                fromModel(response);

                deferred.resolve(response);
            })
            .error(function(error) {
                logOut();
                deferred.reject(error);
            });

        return deferred.promise;
    };

    var fillAuthData = function() {
        var authData = localStorageService.get("authorizationData");
        if (authData) {
            authentication.isAuth = true;
            authentication.email = authData.email;
            authentication.emailConfirmed = authData.emailConfirmed;
            authentication.userName = authData.userName;
            authentication.phoneNumber = authData.phoneNumber;
            authentication.firstName = authData.firstName;
            authentication.lastName = authData.lastName;
            authentication.type = authData.type;
        }
    };

    function clearData() {
        authentication.isAuth = false;
        authentication.email = "";
        authentication.emailConfirmed = false;
        authentication.userName = "";
        authentication.phoneNumber = "";
        authentication.firstName = "";
        authentication.lastName = "";
        authentication.type = "";
    }

    function fromModel(model) {
        authentication.isAuth = true;
        authentication.email = model.email;
        authentication.emailConfirmed = model.emailConfirmed;
        authentication.userName = model.userName;
        authentication.phoneNumber = model.phoneNumber;
        authentication.firstName = model.firstName;
        authentication.lastName = model.lastName;
        authentication.type = model.type;
    }

    authServiceFactory.saveRegistration = saveRegistration;
    authServiceFactory.login = login;
    authServiceFactory.logOut = logOut;
    authServiceFactory.fillAuthData = fillAuthData;
    authServiceFactory.authentication = authentication;

    return authServiceFactory;
}